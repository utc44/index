<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestione Vendite</title>
  <style>
    :root{--blue:#0066ff;--bg:#f6f8fc;--card:#ffffff;--muted:#7b7f88}
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{margin:0;background:linear-gradient(180deg,#7b6ef2 0%, #7a9cff 100%);min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:32px}
    .container{width:100%;max-width:420px;background:transparent}
    header{background:var(--blue);color:#fff;border-radius:18px;padding:28px 22px 24px;box-shadow:0 6px 18px rgba(10,20,70,0.18);margin-bottom:18px}
    header h1{margin:0;font-size:28px;display:flex;align-items:center;gap:10px}
    header p{margin:8px 0 0;color:rgba(255,255,255,0.95);opacity:0.95}
    .card{background:var(--card);border-radius:14px;padding:18px;margin-bottom:18px;box-shadow:0 6px 18px rgba(7,12,30,0.06)}
    label{display:block;color:#4b5563;font-size:14px;margin-bottom:8px}
    input[type=date], input[type=number]{width:100%;padding:14px;border-radius:10px;border:1px solid #e6e9ef;font-size:16px}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:10px;border:none;cursor:pointer}
    .btn-save{background:linear-gradient(180deg,#0e67ff,#0054d6);color:#fff;box-shadow:0 6px 12px rgba(12,83,210,0.18)}
    .stats{display:flex;flex-direction:column;gap:14px}
    .stat-box{background:var(--card);border-radius:12px;padding:22px;text-align:center;box-shadow:0 6px 18px rgba(7,12,30,0.06)}
    .stat-box .big{font-size:32px;color:var(--blue);font-weight:700}
    .muted{color:var(--muted);letter-spacing:2px}
    .list{margin-top:12px}
    .sale-item{display:flex;justify-content:space-between;padding:12px;border-radius:10px;border:1px solid #f0f2f6;margin-bottom:8px}
    .controls{display:flex;gap:10px;align-items:center;margin-top:12px}
    .btn-ghost{background:#fff;border:1px solid #e6e9ef}
    footer{margin-top:12px;text-align:center;color:rgba(255,255,255,0.9)}
    @media (max-width:460px){body{padding:20px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üí∞ Gestione Vendite</h1>
      <p>Traccia le tue vendite giornaliere in modo semplice ed efficace</p>
    </header>

    <div class="card">
      <h3>üìù Inserisci Nuova Vendita</h3>
      <div style="margin-top:12px">
        <label for="saleDate">Data della Vendita</label>
        <input type="date" id="saleDate" />
      </div>

      <div style="margin-top:12px">
        <label for="amount">Importo (‚Ç¨)</label>
        <input type="number" id="amount" placeholder="0.00" step="0.01" min="0" />
      </div>

      <div class="controls">
        <button class="btn btn-save" id="saveBtn">üíæ Salva Vendita</button>
        <button class="btn btn-ghost" id="showBtn">üëÅÔ∏è Mostra Vendite</button>
        <button class="btn btn-ghost" id="clearBtn" title="Cancella tutte le vendite">üóëÔ∏è Azzera</button>
      </div>
    </div>

    <div class="stat-box">
      <div class="big" id="totalCount">0</div>
      <div class="muted">VENDITE TOTALI</div>
    </div>

    <div class="card" id="listCard" style="display:none;margin-top:12px">
      <h3>Lista Vendite</h3>
      <div id="salesList" class="list"></div>
      <div style="margin-top:10px;text-align:right">
        <strong>Totale: </strong><span id="totalSum">‚Ç¨0.00</span>
      </div>
    </div>

    <footer><small>Salvataggio locale nel browser (localStorage). Funziona offline.</small></footer>
  </div>

  <script>
    const STORAGE_KEY = 'gestione_vendite_v1';

    function formatCurrency(v){
      return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(v);
    }

    function todayISO(){
      const d=new Date();
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function supportsDateInput(){
      const i = document.createElement('input');
      i.setAttribute('type','date');
      const notADate = 'not-a-date';
      i.setAttribute('value', notADate);
      return i.value !== notADate;
    }

    // If browser doesn't provide a usable native datepicker, we'll load flatpickr from CDN.
    function ensureDatePicker(){
      const input = document.getElementById('saleDate');
      if(supportsDateInput()){
        // native supported ‚Äî nothing else to do
        return Promise.resolve();
      }
      return new Promise((resolve, reject)=>{
        // load CSS
        const css = document.createElement('link');
        css.rel = 'stylesheet';
        css.href = 'https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css';
        css.onload = ()=>{};
        css.onerror = ()=>console.warn('Could not load flatpickr CSS');
        document.head.appendChild(css);

        // load script
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/flatpickr';
        s.onload = ()=>{
          // initialize on the input
          if(window.flatpickr){
            window.flatpickr(input, {dateFormat: 'Y-m-d', defaultDate: input.value || todayISO()});
            resolve();
          }else{
            reject(new Error('flatpickr not available'));
          }
        };
        s.onerror = ()=>{ console.warn('Could not load flatpickr script'); reject(new Error('load error')); };
        document.body.appendChild(s);
      });
    }

    function loadSales(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw? JSON.parse(raw) : [];
      }catch(e){console.error(e);return []}
    }

    function saveSales(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function addSale(amount, date){
      const sales = loadSales();
      const sale = {id:Date.now(), date: date, amount: Number(amount)};
      sales.push(sale);
      saveSales(sales);
      renderStats();
      renderList();
    }

    function renderStats(){
      const sales = loadSales();
      document.getElementById('totalCount').textContent = sales.length;
      const sum = sales.reduce((s,i)=>s + Number(i.amount||0),0);
      document.getElementById('totalSum').textContent = formatCurrency(sum);
    }

    function renderList(){
      const sales = loadSales().slice().reverse();
      const container = document.getElementById('salesList');
      container.innerHTML = '';
      if(sales.length===0){container.innerHTML = '<div style="color:#667085">Nessuna vendita registrata.</div>'; return}
      sales.forEach(s=>{
        const el = document.createElement('div');
        el.className = 'sale-item';
        // ensure we parse date strings safely
        const date = new Date(s.date + 'T00:00:00');
        const dateStr = date.toLocaleDateString('it-IT',{day:'2-digit',month:'short',year:'numeric'});
        el.innerHTML = `<div>${dateStr}</div><div><strong>${formatCurrency(s.amount)}</strong></div>`;
        container.appendChild(el);
      });
    }

    document.getElementById('saveBtn').addEventListener('click', ()=>{
      const a = document.getElementById('amount').value;
      const d = document.getElementById('saleDate').value || todayISO();
      if(a === '' || isNaN(a) || Number(a) < 0){
        alert('Inserisci un importo valido (>= 0)');
        return;
      }
      addSale(Number(Number(a).toFixed(2)), d);
      document.getElementById('amount').value = '';
    });

    document.getElementById('showBtn').addEventListener('click', ()=>{
      const c = document.getElementById('listCard');
      c.style.display = c.style.display === 'none' ? 'block' : 'none';
      renderList();
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      if(confirm('Sei sicuro di voler cancellare tutte le vendite salvate localmente?')){
        localStorage.removeItem(STORAGE_KEY);
        renderStats();
        renderList();
      }
    });

    // init
    document.getElementById('saleDate').value = todayISO();
    // ensure datepicker (native or flatpickr fallback)
    ensureDatePicker().catch(()=>{
      // if fallback fails, user can still type a date in YYYY-MM-DD format
      console.warn('Datepicker fallback load failed. You can still type a date (YYYY-MM-DD)');
    }).finally(()=>{
      renderStats();
      renderList();
    });
  </script>
</body>
</html>
